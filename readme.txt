== Установка/Обновление ==

<h3 style="text-align: center;">Установка:</h3>
Т.к. это дополнение для WordPress плагина <a href="https://codeseller.ru/groups/plagin-wp-recall-lichnyj-kabinet-na-wordpress/" target="_blank">WP-Recall</a>, то оно устанавливается через <a href="https://codeseller.ru/obshhie-svedeniya-o-dopolneniyax-wp-recall/" target="_blank"><strong>менеджер дополнений WP-Recall</strong></a>.

1. В админке вашего сайта перейдите на страницу "WP-Recall" -> "Дополнения" и в самом верху нажмите на кнопку "Обзор", выберите .zip архив дополнения на вашем пк и нажмите кнопку "Установить".
2. В списке загруженных дополнений, на этой странице, найдите это дополнение, наведите на него курсор мыши и нажмите кнопку "Активировать". Или выберите чекбокс и в выпадающем списке действия выберите "Активировать". Нажмите применить.


<h3 style="text-align: center;">Обновление:</h3>
Дополнение поддерживает <a href="https://codeseller.ru/avtomaticheskie-obnovleniya-dopolnenij-plagina-wp-recall/" target="_blank">автоматическое обновление</a> - два раза в день отправляются вашим сервером запросы на обновление.
Если в течении суток вы не видите обновления (а на странице дополнения вы видите что версия вышла новая), советую ознакомиться с этой <a href="https://codeseller.ru/post-group/rabota-wordpress-krona-cron-prinuditelnoe-vypolnenie-kron-zadach-dlya-wp-recall/" target="_blank">статьёй</a>




== Настройки ==
В админке имеется блок настроек: "WP-Recall" -> "Настройки" -> "Настройки Friends Recall"

Если вы используете базовое дополнение FEED - то возможно "Подписывать при отказе в дружбе" и "Подписывать при удалении из друзей"

Имеется 4-ре варианта вывода списка друзей в ЛК: Списком, Карточкой, Мини карточкой, Аватаркой

И опция "Включать уведомления сайта"

<hr>

<h3>Шорткод</h3>
Имеется шорткод <code>[frnd_online]</code> - "друзья в сети"
- выводит друзей, которые были активны на сайте в течении последних 10-ти минут (активность WP-Recall). 
Сортировка по времени активности. Максимум 10-ть друзей.

Атрибуты шорткода:
<strong>title</strong> - заголовок виджета (по умолчанию "Друзья на сайте:")
<strong>not-friends</strong> - сообщение, когда у пользователя нет ниодного друга (если не указать, то блок "Друзья на сайте:" не выводится. По умолчанию пусто)
<strong>not-online</strong> - сообщение, когда друзей нет в сети (если не указать, то блок "Друзья на сайте:" не выводится если никого нет в сети. По умолчанию пусто)
<strong>guest-text</strong> - сообщение, выводимое незалогиненному пользователю (если не указать, то блок "Друзья на сайте:" не выводится для гостей. По умолчанию пусто)
<strong>number</strong> - предельное кол-во к выводу. Число. По умолчанию 10

Пример:
<code>[frnd_online guest-text="Войдите на сайт и добавьте в друзья" not-online="Никого нет" not-friends="Добавьте кого-нибудь в друзья"]</code>




== F.A.Q. ==
<h3>Как добавить в друзья?</h3>
<strong>2 варианта:</strong>

1. Заходим в личный кабинет к пользователю которого хотим добавить в друзья.
Там под именем кнопка "Добавить в друзья". Нажимаем. Появится окно с предложением вписать текст сообщения к дружбе. Нажимаем кнопку "Отправить запрос в друзья".

2. В отдельной записи публикации. Если выводится WP-Recall блок "Об авторе" - то прям в нем доступна кнопка "Добавить в друзья"



<h3>Как принять запрос на дружбу?</h3>
1. Приходит письмо с уведомлением о новом запросе дружбы. Переходим по ссылке и нажимаем кнопку "Принять запрос в друзья"

2. Переходим в свой личный кабинет. Видим уведомление "У вас: 1 запрос в друзья!" - переходим по ссылке

3. Переходим в свой личный кабинет. Нажимаем на вкладку со счетчиком друзей (область счетчиков). Нажимаем на "Входящие запросы в друзья"

4. Мы в личном кабинете того, кто отправил запрос. Кнопка под именем "Принять запрос в друзья"



<h3>Могу отклонить дружбу?</h3>
- да. Пункт выше. Кнопка называется "Отклонить запрос в друзья".



<h3>Как удалить из друзей?</h3>
Переходим в свой личный кабинет. 
Нажимаем на вкладку со счетчиком друзей (область счетчиков). 
В списке своих друзей нажимаем на кнопку "Убрать из друзей"



<h3>С какими дополнениями WP-Recall он интегрирован?</h3>
1. Базовое дополнение <a href="https://codeseller.ru/products/feed-recall-dopolnenie-wp-recall-dlya-formirovaniya-feed-lenty-novostej-polzovatelya/">Feed</a>. Возможно подписывать пользователя при отказе дружбы и при удалении из друзей.
2. Дополнение <a href="https://codeseller.ru/products/rcl-notification-spisok-uvedomlenij-polzovatelya-v-lichnom-kabinete/" target="_blank">Rcl-Notification</a> - о новом запросе в друзья пользователь узнает через его сообщение на сайте. 
3. Дополнение <a href="https://codeseller.ru/products/smilies-in-emoji/" target="_blank">Smilies in Emoji</a> - то в форме отправки текста к дружбе можно вставлять эмодзи.
4. Дополнение <a href="https://codeseller.ru/products/friends-of-friends/" target="_blank">Friends of Friends</a> - выводит вкладку или шорткодом "Друзья друзей" и считает сколько с ними у вас общих друзей.
5. Дополнение <a href="https://codeseller.ru/products/woman-man/" target="_blank">Woman Man</a> - на основе этого дополнения другие дополнения, связанные с дополнением "Друзья", смогут склонять события и друзей.




== Спонсоры ==

Дополнение "Друзья" вышло в рамках <a href="https://codeseller.ru/project/dopolnenie-k-plaginu-wp-recall-druzya/">"Проектов"</a> сервиса CodeSeller.ru. 
Минимальный взнос участника составил: 200р.
Без финансовой помощи наших друзей - спонсоров данного проекта, мы бы не продвинулись в реализации. Спасибо им за финансовую помощь, поддержку и тестирование!

<strong>Спонсорами выступили:</strong>
[userlist template="mini" include="18914,19799,7692,19928,19544,1,5677,10241,6552,4462,17501,6814,18438"]

<a href="https://codeseller.ru/author/cereal007yandex-ru/">Александр</a> - 2000р.
<a href="https://codeseller.ru/author/grigorash37/">grigorash37</a> - 900р.
<a href="https://codeseller.ru/author/oldisbizgmail-com/">Sergio</a> - 700р.
<a href="https://codeseller.ru/author/samurhan/">Samurhan</a> - 500р.
<a href="https://codeseller.ru/author/photobalbes/">Photobalbes</a> - 300р.
<a href="https://codeseller.ru/author/admin/">Андрей CS</a> - 200р.
<a href="https://codeseller.ru/author/roman201315/">Roman</a> - 200р.
<a href="https://codeseller.ru/author/pbv66/">pbv66</a> - 200р.
<a href="https://codeseller.ru/author/aspirinka/">Максим</a> - 200р.
<a href="https://codeseller.ru/author/ulogin_vkontakte_249199347/">Шурик Шниперсон</a> - 200р.
<a href="https://codeseller.ru/author/litbesinbox-ru/">Litbes</a> - 200р.
<a href="https://codeseller.ru/author/liter-rm/">Liter-rm</a> - 200р.
<a href="https://codeseller.ru/author/denis-bitcoinauto/">Denis.BitcoinAuto</a> - 200р.

- вот так, команда из 13-ти человек помогла воплотить мечту многих пользователей. С помощью данного бесплатного дополнения они вывели WP-Recall на еще один уровень выше!




== Changelog ==
= 2019-10-01 =
v2.0
* Добавлена возможность выбирать (настройка) - где выводить вкладку "Друзья". В области Counters (как было), или в области всех вкладок (область "Menu")

* Если включено дополнение <a href="https://codeseller.ru/products/smilies-in-emoji/" target="_blank">Smilies in Emoji</a> - то в форме отправки текста к дружбе можно вставлять эмодзи.

* В шорткод <code>[frnd_online]</code> добавлены новые атрибуты: 
<strong>number</strong> - предельное кол-во к выводу. Число. По умолчанию 10
<strong>not-friends</strong> - сообщение, когда у пользователя нет ниодного друга (по умолчанию пусто)

* Появилась возможность "Принять запрос в друзья" и "Отклонить запрос в друзья" не только в своем кабинете на соответствующей вкладке, но и на странице того, кто отправил запрос. А также в одиночной записи.
В информационном блоке текст: "Владимир хочет добавить вас в друзья. Вы можете принять запрос или отклонить его, кнопками ниже"
Сообщение к заявке (если есть) и кнопки:
"Принять запрос в друзья" и "Отклонить запрос в друзья"

* Если есть связи: 1 - заявка, 2 - дружит, 4  - заблокирован. Бан
- то кнопку "Подписаться", дополнения FEED, скрываю в ЛК и в одиночной записи.

* Настройка: "В ЛК незалогиненому покажем сообщение?"
Выводит сообщение над ЛК для незалогиненого: "Анжелика знакома вам? Войдите на сайт и вы сможете добавить её в друзья"
Если сайт использует всплывающую форму входа - то слово "Войдите" будет ссылкой на эту форму входа.
Используется склонение к персоне через дополнение<a href="https://codeseller.ru/products/woman-man/" target="_blank">Woman Man</a> 

* Добавлена функция: 
```
frnd_decline_by_sex( $user_id, $data )
```
где <code>$data = ['опубликовал','опубликовала']</code> - массив для склонения на основе пола пользователя, что задается через дополнение <a href="https://codeseller.ru/products/woman-man/" target="_blank">Woman Man</a>
- будет полезна сторонним дополнениям. Например в <a href="https://codeseller.ru/products/friends-cabinet-access/" target="_blank">Friends Cabinet Access</a>

* Теперь имеем следующий набор сообщений:
1. Гостю в ЛК (если вкл в опциях):   "Штучка знакома вам? Войдите на сайт и вы сможете добавить её в друзья"
2. В своём ЛК:                       "У вас: 2 запроса в друзья! Посмотреть"
3. В чужом ЛК, к вам в друзья:       "Matroskin хочет добавить вас в друзья. Вы можете принять запрос или отклонить его кнопками ниже"
4. В чужом ЛК, я к нему в друзья     "Вы уже отправили запрос в друзья этому пользователю"
5. В чужом ЛК - он меня забанил      "Пользователь вас забанил"

* Если это кабинет друга то в тег body добавляется класс <code>frnd_is_friend</code>
- например можно цепляясь за него выводить иконку, что это ваш друг (самостоятельно написав css)

* При удалении пользователя с сайта очищаются все его сообщения к дружбе и связи дружбы.

* В настройки добавлен информационный блок с ссылкой на товарную метку <a href="https://codeseller.ru/product_tag/druzya/" title="Перейти в каталог к товарной метке" target="_blank">"Друзья"</a> - полезно будет, перейти по быстрому, посмотреть что нового.

* Отказ от глобальных переменных. 
Единый класс-загрузчик - в нем определяются все стили, константы и кеширование через свойства класса.
Появились функции-обертки для них.
Оптимизация и уменьшение запросов к БД.
Ресурсы загружаются только там, где нужны.

* Базовые значения кешируются в wp_usermeta: 
'frnd_total_friends' - общее кол-во друзей пользователя
'frnd_incoming_call' - кол-во входящих запросов
'frnd_outgoing_call' - кол-во исходящих запросов
- это позволило в разы сократить запросы к БД.

* По умолчанию теперь список друзей выводит "Мини карточкой". Если вам нужен другой тип вывода - выбирайте в настройках дополнения. Этот шаблон выбран как нечто среднее между информативностью и нагрузкой к базе данных.

* Обращаю внимание что 3 шаблона (user-frnd-ava, user-frnd-card, user-frnd-mini-card) в папке templates были дополнены (Версия шаблона: v1.1).
К хуку (actions) <code>frnd_button</code> добавлен объект <code>$rcl_user</code>.
и добавлен новый хук (actions) <code>frnd_bottom</code> - после счетчиков.
- если вы уже переносили один из шаблонов и правили его - приведите шаблон в актуальное состояние. Если не трогали - после обновления дополнения они сами обновятся.

* Рефакторинг
Переименованы: Старая функция -> новая

frnd_insert_offer_db()          -> frnd_send_friend_request()
frnd_confirm_offer_db()         -> frnd_confirm_friend_request()
frnd_reject_offer_db()          -> frnd_reject_friend_request()
frnd_delete_friend_db()         -> frnd_remove_from_friends()
frnd_get_relation_by_id()       -> frnd_get_relation_friendship()
frnd_incoming_friend_count()    -> frnd_count_incoming_friend_requests()
frnd_outcoming_friend_count()   -> frnd_count_outgoing_friend_requests()
frnd_user_friend_count()        -> frnd_count_user_friends()
frnd_insert_offer_message_db()  -> frnd_send_friend_request_message()
frnd_get_messages_db()          -> frnd_get_friend_request_message()
frnd_online_friends_db()        -> frnd_get_online_friends()

Переименованы хуки:
frnd_offer          -> frnd_send_request
frnd_confirm_offer  -> frnd_confirm_request
frnd_reject_offer   -> frnd_reject_request

* Исправлена ошибка - когда в отдельной записи кнопка "Добавить в друзья" показывалась незалогиненному.
* Исправлена возможная XSS при выводе сообщения к дружбе на экран
* Небольшие правки стилей




= 2019-07-31 =
v1.0.1
* Исправлен баг когда одна и та же кнопка дублировалась в списке пользователей и в подписках/подписчиках


= 2019-07-30 =
v1.0
* Релиз


= 2019-07-30 =
v0.6
* кнопка "Добавить в друзья" теперь выводится у тех кого отправили в подписчики и у того на кого он подписан


= 2019-07-29 =
v0.5
* Интеграция с FEED



= 2019-07-12 =
v0.4
* Уведомления (настройка):
Если у вас включено дополнение <a href="https://codeseller.ru/products/rcl-notification-spisok-uvedomlenij-polzovatelya-v-lichnom-kabinete/" target="_blank">Rcl-Notification</a> -
 то о новом запросе в друзья пользователь узнает через его сообщение на сайте. 
Если же данный доп у вас на сайте не активирован - то при каждой загрузке страницы, если есть не принятые запросы в друзья, слева вверху будет всплывать нотис. 
Это более назойливое сообщение - поэтому пользователю, чтоб скрыть его, придется все входящие сообщения о дружбе обрабатывать (отказать или принять дружбу).



= 2019-07-11 =
v0.3
* Исправлены мелкие недочеты
* У шорткода "Друзья на сайте" появились новые атрибуты:
<strong>title</strong> - заголовок виджета (по умолчанию "Друзья на сайте:")
<strong>not-online</strong> - сообщение когда друзей нет в сети (если не указать то блок "Друзья на сайте:" не выводится если никого нет в сети)
<strong>guest-text</strong> - сообщение выводимое незалогиненному пользователю (если не указать то блок "Друзья на сайте:" не выводится для гостей)

Пример:
<code>[frnd_online guest-text="Войдите на сайт и добавьте в друзья" not-online="Никого нет"]</code>

* Отправляемое письмо о запросе в друзья теперь поддерживает функционал WP-Recall шаблонов. Шаблон mail-friend-offer.php
Работа с шаблонами описана тут: https://codeseller.ru/?p=11632
Ну и теперь на почту приходит симпатично оформленное письмо. 

* Добавлен новый шаблон вывода в вкладке друзей: mini-card (Мини карточкой)
настройка шаблонов и шаблоны были переименованы - поэтому обязательно зайти в настройки допа и заново выбрать опцию "Вариант вывода списка друзей в ЛК"


= 2019-07-10 =
v0.2
* Переименованы события вкладок когда нет друзей, нет входящих/исходящих заявок в друзья.

* К ним добавлены одноименные фильтры:
<code>apply_filters( 'frnd_you_not_friends', $data );</code> - данные вкладки "Друзья", для хозяина кабинета
где         
<pre>$data = [
    'type'   => 'info',
    'border' => true,
    'text'   => 'У вас пока нет друзей',
    'icon'   => 'fa-info-circle',
];</pre>
type - тип блока. Возможны значения: info, success, warning, simple
border - обводка блока true/false
text - текст внутри вкладки. Возможен html
icon - иконка слева внутри блока

А фильтр:
<code>apply_filters( 'frnd_not_friends', $data );</code> - данные вкладки "Друзья", для гостя (сообщение "Пока нет друзей")

<code>apply_filters( 'frnd_not_inc_friends', $data );</code> - данные вкладки "Входящие запросы в друзья"

<code>apply_filters( 'frnd_not_out_friends', $data );</code> - данные вкладки "Заявки в друзья: исходящие"

* кнопка "В друзья" в ЛК выводится раньше чем данные дополнения presents pro

* над ЛК нотис: "У вас 1 запрос в друзья!" - теперь это ссылка. Ведет через ajax сразу на вкладку "Входящие запросы в друзья"

* добавлена настройка позволяющая выбрать как выводить в ЛК список друзей. Вывод шаблонами: Списком (самый подробный), карточкой, аватаркой

* Кнопка "В друзья" добавлена в блок автора отдельной публикации

* Добавлен шорткод [frnd_online] - друзья в сети
Не имеет атрибутов. Выводит друзей, которые были активны на сайте в течении последних 10-ти минут (активность WP-Recall). 
Сортировка по времени активности.


= 2019-06-01 =
v0.1
* Release




== Прочее ==

* Поддержка осуществляется в рамках текущего функционала дополнения
* При возникновении проблемы, создайте соотвествующую тему на форуме поддержки товара
* Если вам нужна доработка под ваши нужды - вы можете обратиться ко мне в <a href="https://codeseller.ru/author/otshelnik-fm/?tab=chat" target="_blank">ЛС</a> с техзаданием на платную доработку.

Все мои работы опубликованы <a href="https://otshelnik-fm.ru/?p=2562&utm_source=free-addons&utm_medium=addon-description&utm_campaign=friends-recall&utm_content=codeseller.ru&utm_term=all-my-addons" target="_blank">на моём сайте</a> и в каталоге магазина <a href="https://codeseller.ru/author/otshelnik-fm/?tab=publics&subtab=type-products" target="_blank">CodeSeller.ru</a>
